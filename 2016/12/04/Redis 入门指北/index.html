<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Redis," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="前言这篇文章是团队内部分享 Introduction-to-Redis 之后的总结。不是完整的演讲稿，与演讲的内容有一定出入。">
<meta name="keywords" content="Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis 入门指北">
<meta property="og:url" content="http://knarfeh.github.io/2016/12/04/Redis 入门指北/index.html">
<meta property="og:site_name" content="Frank&#39;s Notes">
<meta property="og:description" content="前言这篇文章是团队内部分享 Introduction-to-Redis 之后的总结。不是完整的演讲稿，与演讲的内容有一定出入。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://7xi5vu.com1.z0.glb.clouddn.com/2016-12-18/redis_memcached_mysql.png">
<meta property="og:image" content="http://7xi5vu.com1.z0.glb.clouddn.com/redis-master-slave.jpg">
<meta property="og:image" content="http://7xi5vu.com1.z0.glb.clouddn.com/twemproxy.jpg">
<meta property="og:image" content="http://7xi5vu.com1.z0.glb.clouddn.com/redis-cluster-workflow.jpg">
<meta property="og:image" content="http://7xi5vu.com1.z0.glb.clouddn.com/2016-12-13/lizi.jpg">
<meta property="og:image" content="https://img3.doubanio.com/lpic/s28104066.jpg">
<meta property="og:image" content="https://img3.doubanio.com/lpic/s28296984.jpg">
<meta property="og:image" content="https://img1.doubanio.com/lpic/s27297117.jpg">
<meta property="og:updated_time" content="2018-08-18T04:17:16.924Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis 入门指北">
<meta name="twitter:description" content="前言这篇文章是团队内部分享 Introduction-to-Redis 之后的总结。不是完整的演讲稿，与演讲的内容有一定出入。">
<meta name="twitter:image" content="http://7xi5vu.com1.z0.glb.clouddn.com/2016-12-18/redis_memcached_mysql.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Redis 入门指北 | Frank's Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-75002639-1', 'auto');
  ga('send', 'pageview');
</script>









  
  

  <div class="container one-collumn  page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Frank's Notes</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-twitter">
          <a href="/twitter" rel="section">
            
              <i class="menu-item-icon fa fa-coffee fa-fw"></i> <br />
            
            Twitter
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Redis 入门指北
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-04T11:26:27+08:00" content="2016-12-04">
              2016-12-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/04/Redis 入门指北/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/12/04/Redis 入门指北/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章是团队内部分享 <a href="http://knarfeh.com/Introduction-to-Redis/#/" target="_blank" rel="external">Introduction-to-Redis</a> 之后的总结。不是完整的演讲稿，与演讲的内容有一定出入。</p>
<a id="more"></a>
<h2 id="Redis-是什么"><a href="#Redis-是什么" class="headerlink" title="Redis 是什么"></a><a href="https://zh.wikipedia.org/wiki/Redis" target="_blank" rel="external">Redis</a> 是什么</h2><p>Redis 最开始是 <a href="https://github.com/antirez" target="_blank" rel="external">Salvatore Sanfilippo</a> 个人开发的项目，09年开发完成，到现在也不过7年时间，目前已经是最流行的键值对存储数据库。Redis 的作者 antirez 对 Redis 的定义是：一种实现了 TCP 协议的，操作抽象数据类型的守护进程。</p>
<h2 id="为什么要学习，使用-Redis"><a href="#为什么要学习，使用-Redis" class="headerlink" title="为什么要学习，使用 Redis"></a>为什么要学习，使用 Redis</h2><p>Redis 作为一个开源、支持网络、基于内存、键值对存储的数据库，有以下特点 </p>
<ul>
<li>简单，稳定，却不失灵活</li>
<li>存储结构丰富，包括<ul>
<li>字符串类型</li>
<li>散列类型</li>
<li>列表类型</li>
<li>集合类型</li>
<li>有序集合类型</li>
</ul>
</li>
<li>基本只使用内存，可以高速读写</li>
</ul>
<p>更进一步的，我们也可以钻研一下 Redis 的源代码，甚至加入到这个项目来。Redis 正在持续的开发中，就在昨天，antriz 还在他的博客上发了一篇文章：<a href="http://antirez.com/news/110" target="_blank" rel="external">The first release candidate of Redis 4.0 is out</a>。就我个人来说，当我接触一个工具，我会学会怎么使用它，除此之外我还会想要知道它内部的原理。Redis 是一个很有意思的东西，这个项目时间不长，源代码也不多，而且文档丰富。代码很有价值，深入研读一下 redis 的源代码，造造轮子练习一下，当然是很好玩的，这里就不扩展了，之后有更多积累了再写写 Redis 实现的细节。  </p>
<h2 id="Redis-宣言"><a href="#Redis-宣言" class="headerlink" title="Redis 宣言"></a><a href="http://oldblog.antirez.com/post/redis-manifesto.html" target="_blank" rel="external">Redis 宣言</a></h2><p>正式学习前，先来了解一下 Redis 的『内核』吧，antriz 曾经在他的博客上写了几点<a href="http://oldblog.antirez.com/post/redis-manifesto.html" target="_blank" rel="external">关于 Redis 的原则</a>：</p>
<ul>
<li>Redis 是一种实现了 TCP 协议的，操作抽象数据类型的守护进程，本质上是 DSL(Domain Specific language)</li>
</ul>
<p>第一点谈到 Redis 定义的数据结构非常重要，不仅仅与 Redis 的数据类型相关联，还关系着整个系统的时间复杂度和空间复杂度。Redis 设计与实现的第一部分就是数据结构和对象，花了7章，分别从简单动态字符串，链表，字典，跳跃表，整数集合，压缩列表，对象来进行剖析。</p>
<ul>
<li><p>内存存储是第一位的。因为内存操作很快，保证了 Redis 的性能。Redis 会尝试其他的存储方式，实现持久化等，但主线剧情一定在内存上。</p>
</li>
<li><p>为最基本的 API 提供最基本的数据结构，Redis 会避免直接与 API 层接触。『Keep It Simple, Stupid』</p>
</li>
<li><p>代码像诗一样。我们乐于使用其他的库，但是在 Redis 这个小故事里，我们想尽可能地自己执笔。『Keep It Simple, Stupid』</p>
</li>
<li><p>我们讨厌复杂。设计一个系统的过程就是跟复杂做斗争的过程。一个 feature 最好在1000行以内，保持简单的方式是直接不去考虑这个 feature. 『Keep It Simple, Stupid』</p>
</li>
<li><p>有两种层次的 API，一种是为了分布式 Redis 而诞生的，一种是为了支持多键值而诞生的（更复杂）</p>
</li>
<li><p>把优化性能作为一种爱好</p>
</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>all data is in memory(data can be optionally stored on disk)</li>
<li>handles huge workloads easily</li>
<li>mostly O(1) behavior</li>
<li>ideal for write-heavy workloads</li>
<li>support for atomic operations</li>
<li>support for transactions</li>
<li>has pub/sub functionality</li>
<li>tons of client libraries for all major languages</li>
<li>single thread, uses aync. IO</li>
<li>internal scripting with LUA</li>
</ul>
<p>为什么那么多公司都在使用 Redis 呢，实际上和 redis 的功能类似的软件也不少，比如 Memcached，一句话来概括，因为 redis 简单而且强大，Redis 是单线程的模型，而 Memcached 支持多线程，所以对于多核的单例来说，Memecached 的性能会好一点，但是 Redis 的性能已经足够好了，在绝大多数情况下不会有性能瓶颈，除非是数据量太大，IO 会花费一些时间，如果出现瓶颈，一般来自机器内存或网络带宽，而不会来自 CPU。而 Redis 3.0 推出之后，Memcached 几乎所以的功能都成了 Redis 的子集，而且 Redis 自带了集群功能，虽然还不够成熟。基本上 Redis 的性能是非常好的，大多数操作的时间复杂度是常数，支持原子操作，支持事务，发布/订阅的功能，几乎所以流行的语言都有客户端，支持用 lua 做脚本。</p>
<p>Redis 与其他数据库的对比：</p>
<p><img src="http://7xi5vu.com1.z0.glb.clouddn.com/2016-12-18/redis_memcached_mysql.png" alt="compare"></p>
<h2 id="Redis-初体验"><a href="#Redis-初体验" class="headerlink" title="Redis 初体验"></a>Redis 初体验</h2><p>先简单地尝试一下 Redis</p>
<p>上面有谈到，Redis 有5种基本类型，字符串，列表，集合，散列，有序集合。Redis 可以存储键和5种不同数据类型之间的映射。最简单的，也最基本的是字符串：</p>
<p>Redis 中最基础的概念是键值对：你可以获得符合符合规则类型的键名列表，判断一个键是否存在，删除键，获得键值的数据类型等等</p>
<h3 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h3><p>典型用例：</p>
<ol>
<li>增加，减少指定的整数</li>
<li>增加指定浮点数</li>
<li>向尾部追加值</li>
<li>获取字符串长度</li>
<li>同时获得/设置多个键值</li>
<li>位操作</li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ redis-cli</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> set hello <span class="string">"world"</span></div><div class="line">OK</div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> get hello</div><div class="line"><span class="string">"world"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> del hello</div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> get hello</div><div class="line">(<span class="literal">nil</span>)</div></pre></td></tr></table></figure>
<p>这是最简单也最常用的 key，value 的对应，你可以令一个 key 对应一个 value，通过 key 拿到 value 的值，删除这个 key-value，简单来说就是，set 可以设置存储在给定键中的值，get 可以获取给定键中的值，del 删除存储在给定键中的值，</p>
<p>当然你的 value 也可以是整数的形式。可以通过 mget 获得多个键的值。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">set</span> <span class="selector-tag">foo</span> <span class="selector-tag">bar</span></div><div class="line"><span class="selector-tag">OK</span></div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">getset</span> <span class="selector-tag">foo</span> <span class="selector-tag">baz</span></div><div class="line">"<span class="selector-tag">bar</span>"</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">foo</span></div><div class="line">"<span class="selector-tag">baz</span>"</div></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">setnx</span> <span class="selector-tag">foo</span> <span class="selector-tag">bar</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">setnx</span> <span class="selector-tag">foo</span> <span class="selector-tag">baz</span></div><div class="line">(<span class="selector-tag">integer</span>) 0</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">get</span> <span class="selector-tag">foo</span></div><div class="line">"<span class="selector-tag">bar</span>"</div></pre></td></tr></table></figure>
<p>我们有时候需要一些命令的组合，一般的组合命令在 redis 中已经有原生的实现了，可以直接用这些原子操作。比如 get 了一个值，set 一个新的值，你可以用 getset 方法；如果某个键不存在，才进行 set 操作(setnx 是 Set if Not eXists)</p>
<h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><p>接下来我们讲一下列表，redis 支持链表的操作，这里有几个比较典型的命令，你可以在左右两端进行 push，pop 的操作，时间复杂度是O(n)</p>
<p>rpush, lrange, lindex, lpop<br><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">rpush </span><span class="built_in">list-key</span> <span class="string">item</span></div><div class="line">(<span class="string">integer)</span> 1</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">rpush </span><span class="built_in">list-key</span> <span class="string">item1</span></div><div class="line">(<span class="string">integer)</span> 2</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">rpush </span><span class="built_in">list-key</span> <span class="string">item2</span></div><div class="line">(<span class="string">integer)</span> 3</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">lrange </span><span class="built_in">list-key</span> 0 -1</div><div class="line">1) <span class="string">"item"</span></div><div class="line">2) <span class="string">"item1"</span></div><div class="line">3) <span class="string">"item2"</span></div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">lindex </span><span class="built_in">list-key</span> 1</div><div class="line"><span class="string">"item1"</span></div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">lpop </span><span class="built_in">list-key</span></div><div class="line"><span class="string">"item"</span></div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">lrange </span><span class="built_in">list-key</span> 0 -1</div><div class="line">1) <span class="string">"item1"</span></div><div class="line">2) <span class="string">"item2"</span></div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">RPOP </span><span class="built_in">list-key</span></div><div class="line"><span class="string">"item2"</span></div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">lrange </span><span class="built_in">list-key</span> 0 -1</div><div class="line">1) <span class="string">"item1"</span></div></pre></td></tr></table></figure></p>
<h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><p>然后是集合，Redis 的集合和列表都可以存储多个字符串，它们之间的不同在于，列表可以存储多个相同的字符串，而集合通过散列表来保证自己存储的每个字符串都是各不相同的。集合采用的是无序方式存储元素。sadd 可以给集合增加元素，smembers 可以获取包含所有元素的集合，通过 sismember 判断某个元素是不是某个集合里的，使用 srem 移除元素时，会返回被移除元素的数量。</p>
<figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">sadd </span><span class="built_in">set-key</span> <span class="string">item</span></div><div class="line">(<span class="string">integer)</span> 1</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">sadd </span><span class="built_in">set-key</span> <span class="string">item1</span></div><div class="line">(<span class="string">integer)</span> 1</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">sadd </span><span class="built_in">set-key</span> <span class="string">item2</span></div><div class="line">(<span class="string">integer)</span> 1</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">sadd </span><span class="built_in">set-key</span> <span class="string">item</span></div><div class="line">(<span class="string">integer)</span> 0</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">smembers </span><span class="built_in">set-key</span></div><div class="line">1) <span class="string">"item"</span></div><div class="line">2) <span class="string">"item2"</span></div><div class="line">3) <span class="string">"item1"</span></div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">sismember </span><span class="built_in">set-key</span> <span class="string">item3</span></div><div class="line">(<span class="string">integer)</span> 0</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">sismember </span><span class="built_in">set-key</span> <span class="string">item</span></div><div class="line">(<span class="string">integer)</span> 1</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">srem </span><span class="built_in">set-key</span> <span class="string">item1</span></div><div class="line">(<span class="string">integer)</span> 1</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">srem </span><span class="built_in">set-key</span> <span class="string">item1</span></div><div class="line">(<span class="string">integer)</span> 0</div><div class="line"><span class="string">127.</span>0.0.<span class="string">1:6379&gt;</span> <span class="string">smembers </span><span class="built_in">set-key</span></div><div class="line">1) <span class="string">"item"</span></div><div class="line">2) <span class="string">"item2"</span></div></pre></td></tr></table></figure>
<h3 id="散列"><a href="#散列" class="headerlink" title="散列"></a>散列</h3><p>Redis 的散列可以存储多个键值对之间的映射。散列其实像是一个缩略版的 Redis，看起来也像是关系数据库中的行。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; hset hash-key<span class="built_in"> sub-key0 </span>value0</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; hset hash-key<span class="built_in"> sub-key1 </span>value1</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; hset hash-key<span class="built_in"> sub-key2 </span>value2</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; hgetall hash-key</div><div class="line">1) <span class="string">"sub-key0"</span></div><div class="line">2) <span class="string">"value0"</span></div><div class="line">3) <span class="string">"sub-key1"</span></div><div class="line">4) <span class="string">"value1"</span></div><div class="line">5) <span class="string">"sub-key2"</span></div><div class="line">6) <span class="string">"value2"</span></div><div class="line">127.0.0.1:6379&gt; hdel hash-key<span class="built_in"> sub-key1</span></div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; hgetall hash-key</div><div class="line">1) <span class="string">"sub-key0"</span></div><div class="line">2) <span class="string">"value0"</span></div><div class="line">3) <span class="string">"sub-key2"</span></div><div class="line">4) <span class="string">"value2"</span></div></pre></td></tr></table></figure>
<h3 id="有序集合"><a href="#有序集合" class="headerlink" title="有序集合"></a>有序集合</h3><p>有序集合和散列有点像，都存储键值对，但是有序集合的键叫做成员（member），每个成员都是各不相同的，有序集合的值称为分值，分值必须为浮点数。注意，有序集合的键和值跟集合的键和值的位置是相反的。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zadd</span> <span class="selector-tag">zset-key</span> 728 <span class="selector-tag">member1</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zadd</span> <span class="selector-tag">zset-key</span> 729 <span class="selector-tag">member0</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zadd</span> <span class="selector-tag">zset-key</span> 729 <span class="selector-tag">member0</span></div><div class="line">(<span class="selector-tag">integer</span>) 0</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zadd</span> <span class="selector-tag">zset-key</span> 730 <span class="selector-tag">member2</span></div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">zrange</span> <span class="selector-tag">zset-key</span> 0 <span class="selector-tag">-1</span> <span class="selector-tag">withscores</span></div><div class="line">1) "<span class="selector-tag">member1</span>"</div><div class="line">2) "728"</div><div class="line">3) "<span class="selector-tag">member0</span>"</div><div class="line">4) "729"</div><div class="line">5) "<span class="selector-tag">member2</span>"</div><div class="line">6) "730"</div></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrangebyscore zset-key <span class="number">0</span> <span class="number">800</span> withscores</div><div class="line"><span class="number">1</span>) <span class="string">"member1"</span></div><div class="line"><span class="number">2</span>) <span class="string">"728"</span></div><div class="line"><span class="number">3</span>) <span class="string">"member0"</span></div><div class="line"><span class="number">4</span>) <span class="string">"729"</span></div><div class="line"><span class="number">5</span>) <span class="string">"member2"</span></div><div class="line"><span class="number">6</span>) <span class="string">"730"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrangebyscore zset-key <span class="number">0</span> <span class="number">729</span> withscores</div><div class="line"><span class="number">1</span>) <span class="string">"member1"</span></div><div class="line"><span class="number">2</span>) <span class="string">"728"</span></div><div class="line"><span class="number">3</span>) <span class="string">"member0"</span></div><div class="line"><span class="number">4</span>) <span class="string">"729"</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrem zset-key member1</div><div class="line">(integer) <span class="number">1</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrem zset-key member1</div><div class="line">(integer) <span class="number">0</span></div><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> zrange zset-key <span class="number">0</span> -<span class="number">1</span> withscores</div><div class="line"><span class="number">1</span>) <span class="string">"member0"</span></div><div class="line"><span class="number">2</span>) <span class="string">"729"</span></div><div class="line"><span class="number">3</span>) <span class="string">"member2"</span></div><div class="line"><span class="number">4</span>) <span class="string">"730"</span></div></pre></td></tr></table></figure>
<p>通过 zrangebyscore，指定分数的范围，就可以获得对应的有序集合。其他的操作和集合，散列的命令类似，这里就不多说了。了解了有序集合是什么，我们就能想到它能做什么了，比如像 hackernews，twitter 这样的页面，就可以用到。</p>
<h2 id="更进一步"><a href="#更进一步" class="headerlink" title="更进一步"></a>更进一步</h2><p>简单介绍了 redis 的5种数据类型，字符串，列表，集合，散列，有序集合，我们来说说更好玩的。</p>
<h3 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">expire</span> <span class="selector-tag">foo</span> 20</div><div class="line">(<span class="selector-tag">integer</span>) 1</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ttl</span> <span class="selector-tag">foo</span></div><div class="line">(<span class="selector-tag">integer</span>) 18</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ttl</span> <span class="selector-tag">foo</span></div><div class="line">(<span class="selector-tag">integer</span>) 10</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ttl</span> <span class="selector-tag">foo</span></div><div class="line">(<span class="selector-tag">integer</span>) 7</div><div class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:6379</span>&gt; <span class="selector-tag">ttl</span> <span class="selector-tag">foo</span></div><div class="line">(<span class="selector-tag">integer</span>) <span class="selector-tag">-2</span></div></pre></td></tr></table></figure>
<p>我们在实际的开发中经常会遇到一些有时效的数据，比如限时的优惠活动、缓存、验证码等，这些数据可能过了一定时间就要删除。如果是用关系型数据库，需要一个额外的字段来记录到期的时间，定期检测过期的数据，在 Redis 中可以用 expire 来设置一个键的过期时间，到时间后 Redis 会自动删除</p>
<h3 id="发布-订阅"><a href="#发布-订阅" class="headerlink" title="发布/订阅"></a>发布/订阅</h3><p>发布</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">127.0.0.1:6379&gt;</span> publish channel1.<span class="number">1</span> <span class="string">'hello'</span></div><div class="line">(integer) <span class="number">1</span></div></pre></td></tr></table></figure>
<p>订阅</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; subscribe channel1<span class="number">.1</span></div><div class="line"><span class="function"><span class="title">Reading</span></span> messages... (press Ctrl-C to quit)</div><div class="line"><span class="number">1</span>) <span class="string">"subscribe"</span></div><div class="line"><span class="number">2</span>) <span class="string">"channel1.1"</span></div><div class="line"><span class="number">3</span>) (<span class="keyword">integer</span>) <span class="number">1</span></div><div class="line"><span class="number">1</span>) <span class="string">"message"</span></div><div class="line"><span class="number">2</span>) <span class="string">"channel1.1"</span></div><div class="line"><span class="number">3</span>) <span class="string">"hello"</span></div></pre></td></tr></table></figure>
<p>Redis 提供了一组命令让开发者实现『发布/订阅』模式，订阅者可以订阅一个或多个频道（可以通过 pattern 进行订阅），发布者可以向指定的频道发送消息，所有订阅该频道的订阅者都会收到此消息。需要注意的是，这里发布的消息是不会持久化的。订阅的复杂度是：O(1)，发布消息的复杂度是 O(n)</p>
<h3 id="lua-脚本"><a href="#lua-脚本" class="headerlink" title="lua 脚本"></a>lua 脚本</h3><p>Redis 的脚本功能在2.6版推出，它允许开发者写 lua 脚本上传到 redis server 端执行，使用 lua 脚本的好处有：</p>
<ol>
<li>减少网络开销</li>
<li>原子操作</li>
<li>可以复用脚本</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ cat random_list.lua</div><div class="line"><span class="comment">--[[</span></div><div class="line">Random lpush a list key-value</div><div class="line">KEYS[1]:key name</div><div class="line">ARGV[1]:ramdom seed value</div><div class="line">ARGV[2]:add element count</div><div class="line">--]]</div><div class="line"></div><div class="line"><span class="built_in">math</span>.randomseed(ARGV[<span class="number">1</span>]);</div><div class="line"><span class="keyword">for</span> i=<span class="number">1</span>, ARGV[<span class="number">2</span>], <span class="number">1</span> <span class="keyword">do</span></div><div class="line">    redis.call(<span class="string">"lpush"</span>, KEYS[<span class="number">1</span>], <span class="built_in">math</span>.random());</div><div class="line"><span class="keyword">end</span></div><div class="line">redis.log(redis.LOG_NOTICE, <span class="string">"lpush "</span> .. KEYS[<span class="number">1</span>]);</div><div class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">$ redis-cli <span class="comment">--eval random_list.lua r_list , 3 6</span></div></pre></td></tr></table></figure>
<figure class="highlight tcl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ redis-cli <span class="keyword">lrange</span> r_list <span class="number">0</span> <span class="number">-1</span></div><div class="line"><span class="number">1</span>) <span class="string">"0.43370221947957865"</span></div><div class="line"><span class="number">2</span>) <span class="string">"0.54186119723220416"</span></div><div class="line"><span class="number">3</span>) <span class="string">"0.26702763618297298"</span></div><div class="line"><span class="number">4</span>) <span class="string">"0.31170834336043723"</span></div><div class="line"><span class="number">5</span>) <span class="string">"0.86367337352767282"</span></div><div class="line"><span class="number">6</span>) <span class="string">"0.7832349621612742"</span></div></pre></td></tr></table></figure>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><ul>
<li>RDB</li>
<li>AOF</li>
</ul>
<p>Redis 支持两种方式的持久化，一种是 RDB（Relational database） 方式，一种是 AOF(Append-only file) 方式。简单概括一下就是：RDB 是根据指定的规则『定时』将内存中的数据存储在硬盘上，AOF 是指每次执行完命令后，将命令本身记录下来。</p>
<h4 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h4><p>优点:</p>
<ul>
<li>compact, single-file, point-in-time</li>
<li>very good for disaster recovery</li>
<li>maximizes Redis performances, just fork a child</li>
<li>RDB allows faster restarts with big datasets compared to AOF</li>
</ul>
<p>缺点:</p>
<ul>
<li>is NOT good if you need to minimize the chance of data loss in case Redis stops working</li>
<li>Fork() can be time consuming if the dataset is big</li>
</ul>
<p>RDB 是一个非常紧凑的文件，它保存了 redis 在某个时间点上的数据集。这个时间点你是可以自己定的，比如每小时，每个月第一天，它非常适用于灾难恢复，父进程在保存 RDB 文件的时候，唯一需要做的是fork 出一个子进程，父进程不需要进行 IO 操作。在数据集比较大的情况下，RDB 的恢复速度比 AOF 的恢复速度要快，缺点是有可能丢数据，因为这是一个完全备份，而不是一个增量备份。 如果发生故障，那么你至少会丢几分钟的数据。还有一个缺点是，每次保存 RDB 的时候，Redis 都需要 fork 出一个进程，如果数据量比较大，CPU 时间比较紧张，fork 本身这个操作可能会比较费时，可能会导致暂时的不响应。</p>
<h4 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h4><p>优点:</p>
<ul>
<li>much more durable: you can have different fsync policies</li>
<li>AOF log is an append only log</li>
<li>automatically rewrite the AOF in background when it gets too big</li>
<li>AOF contains a log of all the operations one after the other in an easy to understand and parse format</li>
</ul>
<p>使用 AOF 你可以让数据持久化更灵活，比如 fsync 的策略，你可以每秒 sync，或者每次写入命令的时候 sync，默认是每秒 sync，这种配置下，redis 还是可以保持良好的性能，就算发生了宕机，最多丢一秒数据，AOF 文件是一个只进行追加操作的日志文件（append only log），如果磁盘满了，redis-check-aof 工具可以修复这种问题。AOF 文件体积过大时，可以自动在后台对 AOF 文件重写。重写后的新 AOF 文件包含了恢复当前数据集所需的最小命令集合，因为是最小集合，所以容易被人读懂，容易被解析</p>
<p>缺点:</p>
<ul>
<li>usually bigger than the equivalent RDB files </li>
<li>AOF can be slower than RDB depending on the exact fsync policy</li>
<li>experienced rare bugs in specific commands </li>
</ul>
<p>缺点是，AOF 的体积一般要比 RDB 的体积大，如果是使用 fsync，使用 AOF 的性能一般要比 RDB 的性能差。还有一个缺点是，有可能出现比较严重的 bug，因为个别命令的原因，导致 AOF 文件在重新载入时，无法将数据集恢复成保存时的原样，比如 BRPOPLPUSH 这种阻塞命令，曾经引起过这样的 bug，这种 bug 当然是比较少的，而 RDB 就基本不会有这样的 bug。</p>
<h4 id="AOF-还是-RDB？"><a href="#AOF-还是-RDB？" class="headerlink" title="AOF 还是 RDB？"></a>AOF 还是 RDB？</h4><p>antirez 的建议是两种持久化的功能都用，如果你可以忍受几分钟之内的数据丢失，你可以只使用 RDB 持久化，不推荐只使用 AOF 的方式，因为定时生成 RDB 快照（snapshot）非常便于进行数据库备份，RDB 恢复数据集的速度也要比 AOF 恢复的速度要快。</p>
<h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><ul>
<li>复制</li>
<li>哨兵</li>
<li>Redis 集群</li>
</ul>
<p>刚才我们谈到持久化功能，Redis 保证了即使在服务器重启的情况下也不会损失（或少量损失）数据，然而单点的情况还是没有改变，如果这台服务器出现了硬盘故障，就会导致数据丢失，为了避免单点故障，我们需要集群（广义集群，非特指 Redis 集群功能）的功能。</p>
<h3 id="哨兵"><a href="#哨兵" class="headerlink" title="哨兵"></a>哨兵</h3><ul>
<li>Monitoring</li>
<li>Notification</li>
<li>Automatic failover</li>
<li>Configuration provider</li>
</ul>
<p>哨兵是 Redis 在2.8版本推出的功能。主要包括四个方面：  </p>
<ol>
<li>监控，不断检查主服务器和从服务器是否运作正常  </li>
<li>提醒，当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。   </li>
<li>自动故障迁移， 当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作， 它会将失效主服务器的其中一个从服务器升级为新的主服务器， 并让失效主服务器的其他从服务器改为复制新的主服务器。   </li>
<li>提供配置信息，哨兵可以用作客户端的服务发现，他可以高速客户端 master 的地址。Redis Sentinel  也是一个分布式的系统，可以单独起一个哨兵程序，也可以启动一个运行在 sentinel 模式下的 Redis 服务器。即使是使用哨兵的功能，这时的 redis 集群的每个数据库仍然存有集群中的所有数据，从而导致集群的总数据存储量受限于可用存储内存最小的数据库节点，因为 redis 中的所有数据都是基于内存的，所以这个问题会比较突出。 因此 Redis 在3.0版本正式推出了官方支持的集群模式</li>
</ol>
<h3 id="复制"><a href="#复制" class="headerlink" title="复制"></a>复制</h3><p><img src="http://7xi5vu.com1.z0.glb.clouddn.com/redis-master-slave.jpg" alt="redis-master-slave"></p>
<p>Redis 提供了复制（replication）的功能，可以实现当一台数据库中的数据更新后，自动将更新的数据同步到其他数据库上。 master 数据库可以进行读写操作，当写操作导致数据发生变化的时候，自动将数据同步给从数据库， slave 数据库一般是只读的。一个主数据库可以有多个从数据库，从数据库只能有一个主数据库。从数据库不仅可以接收主数据库的同步数据，自己也可以作为主数据库。需要特别注意的是：开启了复制功能，并且主数据库关闭持久化功能时，一定不要用 Supervisor 以及类似的进程工具自动重启主数据库，否则一旦进行了同步，所有的数据都会被清空。为了提高性能，一般从数据库会启用持久化，主数据库会禁用持久化，从数据库崩溃重启了，主数据库会把数据同步过来。主数据库崩溃了，如果是手工通过从数据库恢复，需要严格按照两个步骤进行:  </p>
<p>1 在从数据库中使用 slaveof no one 把从数据库提升为主数据库<br>2 启动崩溃的主数据库，用 slaveof 把主数据库变为主数据库的从数据库，数据就可以恢复回来。 所以说手工恢复是比较麻烦的，我们可以用 redis 提供的哨兵功能来实现这个过程。</p>
<h3 id="Redis-集群"><a href="#Redis-集群" class="headerlink" title="Redis 集群"></a>Redis 集群</h3><p>上面的复制模式，Redis 集群的每个数据库存有集群中的所有数据，集群的总数据存储量受限于可用存储内存最小的数据库节点，形成木桶效应。</p>
<p>以往的 redis 集群，我们可以通过客户端分片来解决，有多个数据库节点的时候，由客户端决定每个键交由哪个数据库节点存储。这样就实现了整个数据库分布在 N 个数据库节点中，每个节点只存放总数据量的1/N。这样你需要扩容的时候，得对数据做手工的迁移，为了保证数据的一致性，还有可能让集群暂时下线，相对比较复杂。客户端分片有很多缺点，维护成本高，增加，移除节点比较繁琐，而且维护相同的分片逻辑成本很大，比如系统中有一个 redis 集群，一套业务系统是 Python 写的，一套的 golang 写的，为了保证分片逻辑的一致性，分片逻辑在两套系统中都得实现，开发成本比较大。于是在 redis cluster 模式推出之前，有一些公司做了 redis 集群的代理模式，比较有名的是 twitter 的 Twemproxy：</p>
<p><img src="http://7xi5vu.com1.z0.glb.clouddn.com/twemproxy.jpg" alt="twemproxy"></p>
<p>Twemproxy 的优点是：  </p>
<ol>
<li>客户端像连接 Redis 实例一样连接 Twemproxy，不需要改任何的代码逻辑。   </li>
<li>支持无效 Redis 实例的自动删除。  </li>
<li>Twemproxy 与 Redis 实例保持连接，减少了客户端与Redis实例的连接数。   </li>
</ol>
<p>也有以下不足：  </p>
<ol>
<li>由于 Redis 客户端的每个请求都经过 Twemproxy 代理才能到达Redis服务器，这个过程中会产生性能损失，当然只有20%。  </li>
<li>没有友好的监控管理后台界面，不利于运维监控。  </li>
<li>最大的问题是 Twemproxy 无法平滑地增加 Redis 实例。对于运维人员来说，当因为业务需要增加 Redis 实例时工作量很大   </li>
</ol>
<p>但这是很长一段时间内最被广泛使用，稳定性最高的 redis 代理。Codis 可以解决 Twemproxy 的不足，可以平滑增加 redis 实例，这里我就不赘述了，目前没有太多研究，也没有什么经验。</p>
<p>Redis 推出了官方的集群功能，采用 P2P 的模式，完全去中心化。</p>
<p><img src="http://7xi5vu.com1.z0.glb.clouddn.com/redis-cluster-workflow.jpg" alt="redis-cluster-workflow"></p>
<p>Redis 的工作模式如上图，Redis 集群使用数据分片（sharding）而非一致性哈希（consistency hashing）来实现： 一个 Redis 集群包含 16384 个哈希槽（hash slot）， 数据库中的每个键都属于这 16384 个哈希槽的其中一个， 集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。如果用户将新节点 D 添加到集群中， 那么集群只需要将节点 A 、B 、 C 中的某些槽移动到节点 D 就可以了。因为将一个哈希槽从一个节点移动到另一个节点不会造成节点阻塞， 所以无论是添加新节点还是移除已存在节点， 又或者改变某个节点包含的哈希槽数量， 都不会造成集群下线。 我们这里假设1负责处理 0 号至 5500 号哈希槽，2负责处理 5501 号至 11000 号哈希槽，3负责处理 11001 号至 16384 号哈希槽。如果节点 2 下线了， 那么集群将无法正常运行， 因为集群找不到节点来处理 5501 号至 11000 号的哈希槽。另一方面， Redis 集群对节点使用了主从复制功能，我们可以给2号设置一个从节点，这种情况就跟 replication 的情况一样了，如果节点 2号的 master 和 slave 都下线，Redis 集群还是会停止工作。 </p>
<p>目前 Redis 3.0 的集群方案有以下两个问题：</p>
<ul>
<li><p>一个 Redis 实例具备了『数据存储』和『路由重定向』，完全去中心化的设计，部署是很简单，但很难对业务进行无痛升级，如果哪天 Redis 集群出了什么严重的 Bug，只能回滚整个 Redis 集群。</p>
</li>
<li><p>对协议进行了较大的修改，对应的 Redis 客户端也需要升级。</p>
</li>
</ul>
<h3 id="如何使用好-Redis"><a href="#如何使用好-Redis" class="headerlink" title="如何使用好 Redis"></a>如何使用好 Redis</h3><p>最后，抛砖引玉，说说我们可以怎么最大程度地利用好 Redis？</p>
<p><img src="http://7xi5vu.com1.z0.glb.clouddn.com/2016-12-13/lizi.jpg" alt="example"></p>
<h4 id="在首页列出最新的评论"><a href="#在首页列出最新的评论" class="headerlink" title="在首页列出最新的评论"></a>在首页列出最新的评论</h4><p>没有 Redis<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> foo <span class="keyword">WHERE</span> ... <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">time</span> <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">10</span></div></pre></td></tr></table></figure></p>
<p>使用 Redis<br><figure class="highlight tcl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">FUNCTION get_latest_comments(start,num_items):</div><div class="line">    id_list = redis.<span class="keyword">lrange</span>(<span class="string">"latest.comments"</span>,start,start+num_items<span class="number">-1</span>)</div><div class="line">    IF id_list.length &lt; num_items</div><div class="line">        id_list = SQL_DB(<span class="string">"SELECT ... ORDER BY time LIMIT ..."</span>)</div><div class="line">    END</div><div class="line">    RETURN id_list</div><div class="line">END</div></pre></td></tr></table></figure></p>
<p>比如有这样一类问题，我们需要查询最新的10条数据，这里就抽象为最新的10条评论吧，如果没有 Redis，我们每次都需要从数据库里面查询数据，如果我们用 Redis 的话，可以将最新的评论保存在 Redis 的列表里，有新的评论就 push 进入，当然 push 进 Redis 的列表后也需要写数据库，取最新评论的时候从 Redis 去取就行了。</p>
<h3 id="实时排名相关问题"><a href="#实时排名相关问题" class="headerlink" title="实时排名相关问题"></a>实时排名相关问题</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ZADD leaderboard <span class="tag">&lt;<span class="name">score</span>&gt;</span> <span class="tag">&lt;<span class="name">username</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ZRANK leaderboard <span class="tag">&lt;<span class="name">username</span>&gt;</span></div></pre></td></tr></table></figure>
<p>Redis 还可以解决跟排名相关的应用，利用 Redis 我们可以高效地实现排序，比如游戏榜单的实时排序，我们可以用一个有序集合来存储，有一个新的数据时，可以用 ZADD 添加数据，需要获得某个用户的排名时，可以用 ZRANK 来获得。 如果只用数据库，比如苹果的 game center，热门的游戏可能有几百万人在玩，如果查数据库的话，实时排名基本就不可能了。</p>
<h4 id="根据用户点赞行为和事件排序的问题"><a href="#根据用户点赞行为和事件排序的问题" class="headerlink" title="根据用户点赞行为和事件排序的问题"></a>根据用户点赞行为和事件排序的问题</h4><p>Redis 可以实时对所有数据进行排序，比如 hacker news，通过一定的公式来对所有的文章进行排序。</p>
<h4 id="计数相关问题"><a href="#计数相关问题" class="headerlink" title="计数相关问题"></a>计数相关问题</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">INCR ip:&lt;<span class="built_in">id</span>&gt;</div><div class="line">EXPIRE ip:&lt;<span class="built_in">id</span>&gt; <span class="number">60</span></div></pre></td></tr></table></figure>
<p>我相信大家都有过这样的需求：给某个值加一个计数器。有一个跟我们平台相关的例子，比如我们需要统计某个时间段内的注册人数，如果5分钟内有几千个注册用户，那么很有可能是被人攻击了，或者我们要分析某个被频繁请求的 api 是否正常，我们可以统计60秒内的独立 ip 访问次数，如果是恶意的请求，我们可以把这个 ip 加入黑名单。如果是存数据库的话，我们确实可以加一个字段，但这是一个频繁写的操作，会比较影响性能。如果是用 Redis 的话，可以很简单地实现这个功能，而且性能比较高</p>
<h4 id="给定时间内的唯一值"><a href="#给定时间内的唯一值" class="headerlink" title="给定时间内的唯一值"></a>给定时间内的唯一值</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SADD page:day1:<span class="tag">&lt;<span class="name">page_id</span>&gt;</span> <span class="tag">&lt;<span class="name">user_id</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SCARD <span class="string">page:</span><span class="string">day1:</span>&lt;page_id&gt;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">SISMEMBER page:day1:<span class="tag">&lt;<span class="name">page_id</span>&gt;</span> <span class="tag">&lt;<span class="name">user_id</span>&gt;</span></div></pre></td></tr></table></figure>
<p>当我们需要判断一个时间段内某个集合内是否已经存在某个值，比如记录今天访问过某个页面的用户，我们可以用一个集合来记录，当一个用户访问了某个页面，我们把这个值记录在集合里，当我们需要知道某个页面的独立用户个数，可以用：SCARD，当我们需要了解某个用户是否访问过某个页面，可以用：SISMEMBER </p>
<h4 id="数据实时分析，反垃圾"><a href="#数据实时分析，反垃圾" class="headerlink" title="数据实时分析，反垃圾"></a>数据实时分析，反垃圾</h4><p>像这种实时分析的服务，一般不需要考虑数据的持久化的问题，但你可能需要大量缓存数据。所以我们可以用 redis 进行数据的实时分析。</p>
<h4 id="Pub-Sub"><a href="#Pub-Sub" class="headerlink" title="Pub/Sub"></a>Pub/Sub</h4><blockquote>
<p>Redis Pub/Sub is very very simple to use, stable, and fast, with support for pattern matching, ability to subscribe/unsubscribe to channels on the run,</p>
</blockquote>
<p>这个前面有提到，Redis 的订阅/发布功能非常容易使用，简单的订阅/发布功能可以用 redis</p>
<h4 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h4><p>A common usage of Redis as a queue is the <a href="https://github.com/blog/542-introducing-resque" target="_blank" rel="external">Resque</a> library, implemented and popularized by Github’s folks.</p>
<p>Redis 可以当做队列使用。github 的 resque 就是基于 Redis 实现的队列系统，这个东西是 ruby 栈的。 </p>
<h2 id="管理-Redis"><a href="#管理-Redis" class="headerlink" title="管理 Redis"></a>管理 Redis</h2><h3 id="安全层面"><a href="#安全层面" class="headerlink" title="安全层面"></a>安全层面</h3><p>还记得 antirz 的 Redis 宣言吗？以简洁为美。在安全层面，Redis 并没有做太多工作。你可以给 Redis 设置一个密码，只需要更改 redis.conf 文件，修改 requirepass 参数的值。</p>
<p>需要注意的是，Redis 的性能极高，并且输入密码错误后 Redis 并不会主动延迟，所以攻击者可以通过穷举的方式破解 Redis 的密码（一秒钟十几万次）。</p>
<h3 id="管理工具"><a href="#管理工具" class="headerlink" title="管理工具"></a>管理工具</h3><ul>
<li>redis-cli</li>
<li>phpRedisAdmin</li>
<li>Rdbtools</li>
</ul>
<h2 id="更多资源"><a href="#更多资源" class="headerlink" title="更多资源"></a>更多资源</h2><h3 id="书"><a href="#书" class="headerlink" title="书"></a>书</h3><p>推荐三本书</p>
<p><a href="https://book.douban.com/subject/26419240/" target="_blank" rel="external"><img src="https://img3.doubanio.com/lpic/s28104066.jpg" alt="Redis 入门指南"></a></p>
<p><a href="https://book.douban.com/subject/26612779/" target="_blank" rel="external"><img src="https://img3.doubanio.com/lpic/s28296984.jpg" alt="Redis 实战"></a></p>
<p><a href="https://book.douban.com/subject/25900156/" target="_blank" rel="external"><img src="https://img1.doubanio.com/lpic/s27297117.jpg" alt="Redis 设计与实现"></a></p>
<p>一本入门，打开新世界的大门，一本实战，教你怎么使用这门功夫，一本内功心法，教你如何融会贯通。</p>
<h3 id="一些常用链接"><a href="#一些常用链接" class="headerlink" title="一些常用链接"></a>一些常用链接</h3><ul>
<li><a href="https://redis.io/" target="_blank" rel="external">redis.io</a></li>
<li><a href="https://redisdoc.com/" target="_blank" rel="external">中文文档</a></li>
<li><a href="http://antirez.com/latest/0" target="_blank" rel="external">antirez.com</a></li>
<li><a href="https://github.com/antirez/redis" target="_blank" rel="external">source code</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Redis/" rel="tag">#Redis</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/11/13/bottlepy 一叶知秋/" rel="next" title="bottlepy 一叶知秋">
                <i class="fa fa-chevron-left"></i> bottlepy 一叶知秋
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/01/30/【译】PEP333-Python Web Server Gateway Interface v1.0/" rel="prev" title="【译】PEP333-Python Web Server Gateway Interface v1.0">
                【译】PEP333-Python Web Server Gateway Interface v1.0 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/6964284?v=3&s=460"
               alt="Frank" />
          <p class="site-author-name" itemprop="name">Frank</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">175</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">125</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/knarfeh" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/knarfeh" target="_blank">
                  
                    <i class="fa fa-twitter"></i> Twitter
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/2753500945" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-是什么"><span class="nav-number">2.</span> <span class="nav-text">Redis 是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#为什么要学习，使用-Redis"><span class="nav-number">3.</span> <span class="nav-text">为什么要学习，使用 Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-宣言"><span class="nav-number">4.</span> <span class="nav-text">Redis 宣言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#特性"><span class="nav-number">5.</span> <span class="nav-text">特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-初体验"><span class="nav-number">6.</span> <span class="nav-text">Redis 初体验</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串"><span class="nav-number">6.1.</span> <span class="nav-text">字符串</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#列表"><span class="nav-number">6.2.</span> <span class="nav-text">列表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集合"><span class="nav-number">6.3.</span> <span class="nav-text">集合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#散列"><span class="nav-number">6.4.</span> <span class="nav-text">散列</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#有序集合"><span class="nav-number">6.5.</span> <span class="nav-text">有序集合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更进一步"><span class="nav-number">7.</span> <span class="nav-text">更进一步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Expires"><span class="nav-number">7.1.</span> <span class="nav-text">Expires</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布-订阅"><span class="nav-number">7.2.</span> <span class="nav-text">发布/订阅</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lua-脚本"><span class="nav-number">7.3.</span> <span class="nav-text">lua 脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久化"><span class="nav-number">7.4.</span> <span class="nav-text">持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB"><span class="nav-number">7.4.1.</span> <span class="nav-text">RDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOF"><span class="nav-number">7.4.2.</span> <span class="nav-text">AOF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOF-还是-RDB？"><span class="nav-number">7.4.3.</span> <span class="nav-text">AOF 还是 RDB？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高可用"><span class="nav-number">8.</span> <span class="nav-text">高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#哨兵"><span class="nav-number">8.1.</span> <span class="nav-text">哨兵</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制"><span class="nav-number">8.2.</span> <span class="nav-text">复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-集群"><span class="nav-number">8.3.</span> <span class="nav-text">Redis 集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何使用好-Redis"><span class="nav-number">8.4.</span> <span class="nav-text">如何使用好 Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#在首页列出最新的评论"><span class="nav-number">8.4.1.</span> <span class="nav-text">在首页列出最新的评论</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实时排名相关问题"><span class="nav-number">8.5.</span> <span class="nav-text">实时排名相关问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#根据用户点赞行为和事件排序的问题"><span class="nav-number">8.5.1.</span> <span class="nav-text">根据用户点赞行为和事件排序的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#计数相关问题"><span class="nav-number">8.5.2.</span> <span class="nav-text">计数相关问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#给定时间内的唯一值"><span class="nav-number">8.5.3.</span> <span class="nav-text">给定时间内的唯一值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据实时分析，反垃圾"><span class="nav-number">8.5.4.</span> <span class="nav-text">数据实时分析，反垃圾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pub-Sub"><span class="nav-number">8.5.5.</span> <span class="nav-text">Pub/Sub</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#队列"><span class="nav-number">8.5.6.</span> <span class="nav-text">队列</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#管理-Redis"><span class="nav-number">9.</span> <span class="nav-text">管理 Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安全层面"><span class="nav-number">9.1.</span> <span class="nav-text">安全层面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#管理工具"><span class="nav-number">9.2.</span> <span class="nav-text">管理工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#更多资源"><span class="nav-number">10.</span> <span class="nav-text">更多资源</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#书"><span class="nav-number">10.1.</span> <span class="nav-text">书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些常用链接"><span class="nav-number">10.2.</span> <span class="nav-text">一些常用链接</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frank</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.scheme !== 'Pisces' && (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always')) {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'knarfeh';
      var disqus_identifier = '2016/12/04/Redis 入门指北/';
      var disqus_title = 'Redis 入门指北';
      var disqus_url = 'http://knarfeh.github.io/2016/12/04/Redis 入门指北/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  


</body>
</html>
