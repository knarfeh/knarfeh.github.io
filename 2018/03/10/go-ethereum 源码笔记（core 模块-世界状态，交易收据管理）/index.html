<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="cryptocurrency,Golang,geth," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="通过前面的文章，我们了解了 geth 的大致原理，知道了区块链是怎么组织构成的，有了 rlp，MPT 这些数据结构的基础，也知道了账户是怎么组织的，交易是如何管理的，挖矿是一个什么样的流程，这一篇我们将深入到交易的具体处理过程，看看交易过程中是如何修改世界状态，生成交易收据的。 这篇文章将涉及到 core/types/transaction.go, core/state 模块，需要对交易池，账户等">
<meta name="keywords" content="cryptocurrency,Golang,geth">
<meta property="og:type" content="article">
<meta property="og:title" content="go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）">
<meta property="og:url" content="http://knarfeh.github.io/2018/03/10/go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）/index.html">
<meta property="og:site_name" content="Frank&#39;s Notes">
<meta property="og:description" content="通过前面的文章，我们了解了 geth 的大致原理，知道了区块链是怎么组织构成的，有了 rlp，MPT 这些数据结构的基础，也知道了账户是怎么组织的，交易是如何管理的，挖矿是一个什么样的流程，这一篇我们将深入到交易的具体处理过程，看看交易过程中是如何修改世界状态，生成交易收据的。 这篇文章将涉及到 core/types/transaction.go, core/state 模块，需要对交易池，账户等">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://knarfeh-1254074221.cos.na-siliconvalley.myqcloud.com/stackexchange-ethereum-block-architecture.jpg">
<meta property="og:updated_time" content="2018-10-12T03:47:40.895Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）">
<meta name="twitter:description" content="通过前面的文章，我们了解了 geth 的大致原理，知道了区块链是怎么组织构成的，有了 rlp，MPT 这些数据结构的基础，也知道了账户是怎么组织的，交易是如何管理的，挖矿是一个什么样的流程，这一篇我们将深入到交易的具体处理过程，看看交易过程中是如何修改世界状态，生成交易收据的。 这篇文章将涉及到 core/types/transaction.go, core/state 模块，需要对交易池，账户等">
<meta name="twitter:image" content="https://knarfeh-1254074221.cos.na-siliconvalley.myqcloud.com/stackexchange-ethereum-block-architecture.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> go-ethereum 源码笔记（core 模块-世界状态，交易收据管理） | Frank's Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-75002639-1', 'auto');
  ga('send', 'pageview');
</script>









  
  

  <div class="container one-collumn  page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Frank's Notes</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-twitter">
          <a href="/twitter" rel="section">
            
              <i class="menu-item-icon fa fa-coffee fa-fw"></i> <br />
            
            Twitter
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-03-10T22:35:06+08:00" content="2018-03-10">
              2018-03-10
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/03/10/go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/10/go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>通过前面的文章，我们了解了 geth 的大致原理，知道了区块链是怎么组织构成的，有了 rlp，MPT 这些数据结构的基础，也知道了账户是怎么组织的，交易是如何管理的，挖矿是一个什么样的流程，这一篇我们将深入到交易的具体处理过程，看看交易过程中是如何修改世界状态，生成交易收据的。</p>
<p>这篇文章将涉及到 <code>core/types/transaction.go</code>, <code>core/state</code> 模块，需要对交易池，账户等基本概念有所了解。</p>
<p><code>core/state</code> 包提供了用户和合约的状态管理的功能。包括 trie，数据库，cache，日志和回滚相关功能。还记得<a href="https://knarfeh.com/2018/03/10/go-ethereum%20%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%EF%BC%88%E6%A6%82%E8%A7%88%EF%BC%89/" target="_blank" rel="external">go-ethereum 源码笔记（概览）</a> 中曾给出的总体架构图吗？</p>
<p><img src="https://knarfeh-1254074221.cos.na-siliconvalley.myqcloud.com/stackexchange-ethereum-block-architecture.jpg" alt="https://i.stack.imgur.com/afWDt.jpg"> 按照定义，日志应该属于交易树的部分，但 <code>core/state</code> 中的 <code>journal.go</code> 却提供了日志的管理，这里有点不符合逻辑，可以稍稍注意一下。</p>
<a id="more"></a>
<p>前面的文章中有提过，在 geth 中存在三棵主要的 MPT 树，状态树，交易树，收据树。在交易上链的过程中，状态树，收据树会不断改变，</p>
<p>世界状态其实是一个账户地址和账户状态的映射，不管是外部账户还是合约账户，账户状态都包括：</p>
<ul>
<li>nonce，如果账户是一个外部拥有账户，nonce 代表从此账户地址发送的交易序号。如果账户是一个合约账户，nonce 代表此账户创建的合约序号</li>
<li>balance，该地址拥有 Wei 的数量。1Ether=10^18Wei</li>
<li>storageRoot， MPT 树的根节点哈希值。这个 MPT 会将此账户存储内容的哈希值进行编码，默认是空值</li>
<li>codeHash，该账户 EVM 代码的哈希值。对于合约账户，就是被哈希之后的代码，以 codeHash 保存。对于外部拥有账户，codeHash 是一个空字符串的哈希值</li>
</ul>
<p>以太坊还会为每笔交易生成收据，每张收据都包含有关交易的某些信息。包括以下内容：</p>
<ul>
<li>区块号</li>
<li>区块哈希</li>
<li>事务哈希值</li>
<li>当前交易使用的 gas</li>
<li>在当前交易执行后当前块中使用的 gas</li>
<li>执行当前事务时创建的日志</li>
</ul>
<p>我们先从收据树入手。</p>
<h2 id="插入区块更新状态"><a href="#插入区块更新状态" class="headerlink" title="插入区块更新状态"></a>插入区块更新状态</h2><h3 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h3><p>还记得在 <a href="https://knarfeh.com/2018/03/10/go-ethereum%20%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%EF%BC%88core%20%E6%A8%A1%E5%9D%97-%E5%8C%BA%E5%9D%97%E9%93%BE%E6%93%8D%E4%BD%9C%EF%BC%89/" target="_blank" rel="external">go-ethereum 源码笔记（core 模块-区块链操作）</a> 这一篇的 insertChain 方法中，有一个调用 <code>receipts, logs, usedGas, err := bc.processor.Process(block, state, bc.vmConfig)</code> 的动作，这是在插入转账区块后，更新状态树，收据树，我们来看看 <code>Process</code> 具体做了什么。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">func (<span class="selector-tag">p</span> *StateProcessor) Process(block *types<span class="selector-class">.Block</span>, statedb *state<span class="selector-class">.StateDB</span>, cfg vm.Config) (types<span class="selector-class">.Receipts</span>, []*types<span class="selector-class">.Log</span>, uint64, error) &#123;</div><div class="line">	<span class="selector-tag">var</span> (</div><div class="line">		receipts types<span class="selector-class">.Receipts</span></div><div class="line">		usedGas  = new(uint64)</div><div class="line">		<span class="selector-tag">header</span>   = block.Header()</div><div class="line">		allLogs  []*types<span class="selector-class">.Log</span></div><div class="line">		gp       = new(GasPool).AddGas(block.GasLimit())</div><div class="line">	)</div><div class="line">	<span class="keyword">if</span> <span class="selector-tag">p</span><span class="selector-class">.config</span><span class="selector-class">.DAOForkSupport</span> &amp;&amp; <span class="selector-tag">p</span><span class="selector-class">.config</span><span class="selector-class">.DAOForkBlock</span> != nil &amp;&amp; <span class="selector-tag">p</span><span class="selector-class">.config</span><span class="selector-class">.DAOForkBlock</span><span class="selector-class">.Cmp</span>(block.Number()) == <span class="number">0</span> &#123;</div><div class="line">		misc.ApplyDAOHardFork(statedb)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> <span class="selector-tag">i</span>, tx := range block.Transactions() &#123;</div><div class="line">		statedb.Prepare(tx.Hash(), block.Hash(), i)</div><div class="line">		receipt, _, err := ApplyTransaction(<span class="selector-tag">p</span><span class="selector-class">.config</span>, <span class="selector-tag">p</span><span class="selector-class">.bc</span>, nil, gp, statedb, <span class="selector-tag">header</span>, tx, usedGas, cfg)</div><div class="line">		<span class="keyword">if</span> err != nil &#123;</div><div class="line">			return nil, nil, <span class="number">0</span>, err</div><div class="line">		&#125;</div><div class="line">		receipts = append(receipts, receipt)</div><div class="line">		allLogs = append(allLogs, receipt<span class="selector-class">.Logs</span>...)</div><div class="line">	&#125;</div><div class="line">	<span class="selector-tag">p</span><span class="selector-class">.engine</span><span class="selector-class">.Finalize</span>(<span class="selector-tag">p</span><span class="selector-class">.bc</span>, <span class="selector-tag">header</span>, statedb, block.Transactions(), block.Uncles(), receipts)</div><div class="line"></div><div class="line">	return receipts, allLogs, *usedGas, nil</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Process</code> 根据以太坊规则运行交易来对改变 statedb 的状态，以奖励挖矿者或其他的叔父节点。<code>Process</code> 会返回执行过程中累计的收据和日志，并返回过程中使用的 gas，如果 gas 不足导致任何交易执行失败，返回错误。</p>
<p><code>Process</code> 首先会声明变量，值得注意的是 GasPool 变量，它告诉你剩下还有多少 Gas 可以使用，在每一个交易的执行过程中，以太坊设计了 refund 的机制进行处理，偿还的 gas 也会加到 GasPool 中。接着处理 DAO 事件的硬分叉，接着遍历区块中的所有交易，通过调用 <code>ApplyTransaction</code> 获得每个交易的收据。这个过程结束后，调用一致性引擎的 <code>Finalize</code>，拿到区块奖励或叔块奖励，最终将世界状态写入到区块链中，也就是说 stateTrie 随着每次交易的执行变化，这个过程在 <a href="https://knarfeh.com/2018/03/10/go-ethereum%20%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%EF%BC%88trie%20%E6%A8%A1%E5%9D%97-MPT%20%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%89/" target="_blank" rel="external">go-ethereum 源码笔记（trie 模块-MPT 的实现）</a> 也有提及，它通过 StateDB 的 <code>IntermediateRoot()</code> 方法实现。我们先深入到 <code>ApplyTransaction</code> 看看每一个交易是如何构成收据的。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">func ApplyTransaction(config *params<span class="selector-class">.ChainConfig</span>, bc ChainContext, author *common<span class="selector-class">.Address</span>, gp *GasPool, statedb *state<span class="selector-class">.StateDB</span>, <span class="selector-tag">header</span> *types<span class="selector-class">.Header</span>, tx *types<span class="selector-class">.Transaction</span>, usedGas *uint64, cfg vm.Config) (*types<span class="selector-class">.Receipt</span>, uint64, error) &#123;</div><div class="line">	msg, err := tx.AsMessage(types.MakeSigner(config, <span class="selector-tag">header</span>.Number))</div><div class="line">	<span class="keyword">if</span> err != nil &#123;</div><div class="line">		return nil, <span class="number">0</span>, err</div><div class="line">	&#125;</div><div class="line">	vmenv := vm.NewEVM(context, statedb, config, cfg)</div><div class="line">	_, gas, failed, err := ApplyMessage(vmenv, msg, gp)</div><div class="line">	<span class="keyword">if</span> err != nil &#123;</div><div class="line">		return nil, <span class="number">0</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="selector-tag">var</span> root []byte</div><div class="line">	<span class="keyword">if</span> config.IsByzantium(<span class="selector-tag">header</span>.Number) &#123;</div><div class="line">		statedb.Finalise(true)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		root = statedb.IntermediateRoot(config.IsEIP158(<span class="selector-tag">header</span>.Number)).Bytes()</div><div class="line">	&#125;</div><div class="line">	*usedGas += gas</div><div class="line"></div><div class="line">	receipt := types.NewReceipt(root, failed, *usedGas)</div><div class="line">	receipt<span class="selector-class">.TxHash</span> = tx.Hash()</div><div class="line">	receipt<span class="selector-class">.GasUsed</span> = gas</div><div class="line">	<span class="keyword">if</span> msg.To() == nil &#123;</div><div class="line">		receipt<span class="selector-class">.ContractAddress</span> = crypto.CreateAddress(vmenv<span class="selector-class">.Context</span><span class="selector-class">.Origin</span>, tx.Nonce())</div><div class="line">	&#125;</div><div class="line">	receipt<span class="selector-class">.Logs</span> = statedb.GetLogs(tx.Hash())</div><div class="line">	receipt<span class="selector-class">.Bloom</span> = types.CreateBloom(types.Receipts&#123;receipt&#125;)</div><div class="line"></div><div class="line">	return receipt, gas, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于每个交易，都会创建一个新的虚拟机环境，即根据输入参数封装 EVM 对象，接着调用 <code>ApplyMessage</code> 将交易应用于当前的状态中，<code>Finalise</code> 方法会调用 update 方法，将存放在 cache 的修改写入 trie 数据库中，返回的是使用的 gas，这部分代码涉及到 <code>core/state_transition.go</code>。</p>
<p>接着，如果是拜占庭硬分叉，直接调用 <code>statedb.Finalise(true)</code>，否则调用 <code>statedb.IntermediateRoot(config.IsEIP158(header.Number)).Bytes()</code>，最后，初始化一个收据对象，其 <code>TxHash</code> 为交易哈希，<code>Logs</code> 字段通过 <code>statedb.GetLogs(tx.Hash())</code> 拿到，<code>Bloom</code> 字段通过 <code>types.CreateBloom(types.Receipts{receipt})</code> 创建，最后返回收据和消耗的 gas。</p>
<h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>Process 部分的代码是插入区块时被调用的，而我们发现 Process 在处理每一个交易时，最终会调用 <code>core/state_transition.go</code> 中的 <code>Finalise</code>，实际上，如果说 <code>core/state_processor.go</code> 是用来处理区块级别的交易，那么可以说 <code>core/state_transition.go</code> 是用来处理一个一个的交易，最终将获得世界状态，收据，gas 等信息。</p>
<p>Transition 完成世界状态转换的工作，它会利用世界状态来执行交易，然后改变当前的世界状态。我们可以细看一下 <code>TransitionDb()</code> 的执行过程。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">func (<span class="keyword">st</span> *StateTransition) TransitionDb() (<span class="keyword">ret</span> []byte, usedGas uint64, failed bool, <span class="keyword">err</span> <span class="keyword">error</span>) &#123;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">err</span> = <span class="keyword">st</span>.preCheck(); <span class="keyword">err</span> != nil &#123;</div><div class="line">		<span class="built_in">return</span></div><div class="line">	&#125;</div><div class="line">	msg := <span class="keyword">st</span>.msg</div><div class="line">	sender := vm.AccountRef(msg.From())</div><div class="line">	homestead := <span class="keyword">st</span>.evm.ChainConfig().IsHomestead(<span class="keyword">st</span>.evm.BlockNumber)</div><div class="line">	contractCreation := msg.To() == nil</div><div class="line"></div><div class="line">	gas, <span class="keyword">err</span> := IntrinsicGas(<span class="keyword">st</span>.data, contractCreation, homestead)</div><div class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</div><div class="line">		<span class="keyword">return</span> nil, 0, false, <span class="keyword">err</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">err</span> = <span class="keyword">st</span>.useGas(gas); <span class="keyword">err</span> != nil &#123;</div><div class="line">		<span class="keyword">return</span> nil, 0, false, <span class="keyword">err</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> (</div><div class="line">		evm = <span class="keyword">st</span>.evm</div><div class="line">		vmerr <span class="keyword">error</span></div><div class="line">	)</div><div class="line">	<span class="keyword">if</span> contractCreation &#123;</div><div class="line">		<span class="keyword">ret</span>, _, <span class="keyword">st</span>.gas, vmerr = evm.Create(sender, <span class="keyword">st</span>.data, <span class="keyword">st</span>.gas, <span class="keyword">st</span>.value)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">st</span>.state.SetNonce(msg.From(), <span class="keyword">st</span>.state.GetNonce(sender.Address())+1)</div><div class="line">		<span class="keyword">ret</span>, <span class="keyword">st</span>.gas, vmerr = evm.Call(sender, <span class="keyword">st</span>.to(), <span class="keyword">st</span>.data, <span class="keyword">st</span>.gas, <span class="keyword">st</span>.value)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> vmerr != nil &#123;</div><div class="line">		<span class="keyword">log</span>.Debug(<span class="string">"VM returned with error"</span>, <span class="string">"err"</span>, vmerr)</div><div class="line">		<span class="keyword">if</span> vmerr == vm.ErrInsufficientBalance &#123;</div><div class="line">			<span class="keyword">return</span> nil, 0, false, vmerr</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">st</span>.refundGas()</div><div class="line">	<span class="keyword">st</span>.state.AddBalance(<span class="keyword">st</span>.evm.Coinbase, new(big.Int).Mul(new(big.Int).SetUint64(<span class="keyword">st</span>.gasUsed()), <span class="keyword">st</span>.gasPrice))</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="keyword">ret</span>, <span class="keyword">st</span>.gasUsed(), vmerr != nil, <span class="keyword">err</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>TransitionDb</code> 首先会调用 <code>preCheck</code>，<code>preCheck</code> 的作用是检测 Nonce 的值是否正确，然后通过 <code>buyGas()</code> 购买 Gas。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">func (<span class="keyword">st</span> *StateTransition) buyGas() <span class="keyword">error</span> &#123;</div><div class="line">	mgval := new(big.Int).Mul(new(big.Int).SetUint64(<span class="keyword">st</span>.msg.Gas()), <span class="keyword">st</span>.gasPrice)</div><div class="line">	<span class="keyword">if</span> <span class="keyword">st</span>.state.GetBalance(<span class="keyword">st</span>.msg.From()).Cmp(mgval) &lt; 0 &#123;</div><div class="line">		<span class="keyword">return</span> errInsufficientBalanceForGas</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">err</span> := <span class="keyword">st</span>.gp.SubGas(<span class="keyword">st</span>.msg.Gas()); <span class="keyword">err</span> != nil &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">err</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">st</span>.gas += <span class="keyword">st</span>.msg.Gas()</div><div class="line"></div><div class="line">	<span class="keyword">st</span>.initialGas = <span class="keyword">st</span>.msg.Gas()</div><div class="line">	<span class="keyword">st</span>.state.SubBalance(<span class="keyword">st</span>.msg.From(), mgval)</div><div class="line">	<span class="keyword">return</span> nil</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>buyGas</code> 会从交易的转出方账户扣除 <code>GasLimit * gasPrice</code>，GasPool 也会减掉这笔 Gas 消耗。</p>
<p>回到 <code>TransitionDb</code> 方法，在 <code>preCheck()</code> 之后，会调用 <code>IntrinsicGas</code> 方法，计算交易的固有 Gas 消耗，这个消耗有两部分，一部分是交易（或创建合约）预设消耗量，一部分是根据交易 data 的非0字节和0字节长度决定的消耗量，<code>TransitionDb</code> 方法中最终会从 gas 中减去这笔消耗。再接下来就是 EVM 的执行，如果是创建合约，调用的是 <code>evm.Create(sender, st.data, st.gas, st.value)</code>，如果是普通的交易，调用的是 <code>evm.Call(sender, st.to(), st.data, st.gas, st.value)</code>，这两个方法很重要，在接下来的 (go-ethereum 源码笔记（core 模块-EVM）)[#TODO] 这篇文章中会有讲解，这两个方法同样也会消耗 gas。接着调用 <code>refundGas</code> 方法执行退 gas 的操作。</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">func (st *StateTransition) refundGas() &#123;</div><div class="line">	<span class="attribute">refund</span> := st<span class="variable">.gasUsed</span>() / 2</div><div class="line">	if refund &gt; st<span class="variable">.state</span><span class="variable">.GetRefund</span>() &#123;</div><div class="line">		refund = st<span class="variable">.state</span><span class="variable">.GetRefund</span>()</div><div class="line">	&#125;</div><div class="line">	st<span class="variable">.gas</span> += refund</div><div class="line"></div><div class="line">	remaining := new(big<span class="variable">.Int</span>)<span class="variable">.Mul</span>(new(big<span class="variable">.Int</span>)<span class="variable">.SetUint</span>64(st<span class="variable">.gas</span>), st<span class="variable">.gasPrice</span>)</div><div class="line">	st<span class="variable">.state</span><span class="variable">.AddBalance</span>(st<span class="variable">.msg</span><span class="variable">.From</span>(), remaining)</div><div class="line">	st<span class="variable">.gp</span><span class="variable">.AddGas</span>(st<span class="variable">.gas</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>refundGas</code> 首先会将用户剩下的 gas 还回去，但退回的金额不会超过用户使用的 gas 的 1/2。</p>
<p><code>TransitionDb</code> 最后会通过 <code>st.state.AddBalance</code> 奖励区块的挖掘者，这笔钱等于 <code>gasPrice*(initialGas-gas)</code>，至此，这个交易的 gas 消耗量计算就完成了。</p>
<h2 id="state-模块"><a href="#state-模块" class="headerlink" title="state 模块"></a>state 模块</h2><p>在上面的 Process, Transition 小节，我们了解了 geth 中状态管理的部分功能，实际上就管理世界状态而言，<code>core/state</code> 还提供了很多其他功能，不过这些功能大多只是在 EVM 进行合约的操作时才使用到，例如 <code>core/vm/instructions.go</code> 中的 makeLog 指令，在进行出栈操作后，最终还是会通过 StateDB 的 AddLog 方法实现写日志的功能。这里我们将深入 <code>core/state</code> 模块的实现，限于篇幅，无法面面俱到，我们只分析几个应用场景。</p>
<h3 id="存储以太坊合约和账户-StateDB"><a href="#存储以太坊合约和账户-StateDB" class="headerlink" title="存储以太坊合约和账户 StateDB"></a>存储以太坊合约和账户 StateDB</h3><p>stateDB 用来与以太坊中的世界状态进行交互，它可以与状态树进行交互，提供了检索合约，账户的功能。</p>
<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">type StateDB struct &#123;</div><div class="line">	db   Database</div><div class="line">	trie Trie</div><div class="line">	</div><div class="line">	<span class="keyword">state</span>Objects      map[common.Address]*<span class="keyword">state</span>Object</div><div class="line">	<span class="keyword">state</span>ObjectsDirty map[common.Address]struct&#123;&#125;</div><div class="line"></div><div class="line">	dbErr error</div><div class="line">	refund uint64</div><div class="line"></div><div class="line">	thash, bhash common.Hash</div><div class="line">	txIndex      int</div><div class="line">	logs         map[common.Hash][]*types.Log</div><div class="line">	<span class="keyword">log</span>Size      uint</div><div class="line"></div><div class="line">	preimages map[common.Hash][]byte</div><div class="line"></div><div class="line">	journal        *journal</div><div class="line">	validRevisions []revision</div><div class="line">	nextRevisionId int</div><div class="line"></div><div class="line">	lock sync.Mutex</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中 <code>stateObjects</code> 用来缓存状态对象，<code>stateObjectsDirty</code> 用来缓存被修改过的对象，这部分代码在 <code>core/state/state_object.go</code> 里。<code>stateObject</code> 主要依赖于 <code>core/state/database.go</code>，<code>core/state/database.go</code> 中的 Database（也是 StateDB 中的 Database） 封装了一下对 MPT 树的操作，可以增删改查世界状态，余额等。<br>journal 表示操作日志，<code>core/state/journal.go</code> 针对各种操作日志提供了对应的回滚功能，可以基于这个日志做一些事务类型的操作。</p>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(root common.Hash, db Database)</span> <span class="params">(*StateDB, error)</span></span> &#123;</div><div class="line">	tr, err := db.OpenTrie(root)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;StateDB&#123;</div><div class="line">		db:                db,</div><div class="line">		trie:              tr,</div><div class="line">		stateObjects:      <span class="built_in">make</span>(<span class="keyword">map</span>[common.Address]*stateObject),</div><div class="line">		stateObjectsDirty: <span class="built_in">make</span>(<span class="keyword">map</span>[common.Address]<span class="keyword">struct</span>&#123;&#125;),</div><div class="line">		logs:              <span class="built_in">make</span>(<span class="keyword">map</span>[common.Hash][]*types.Log),</div><div class="line">		preimages:         <span class="built_in">make</span>(<span class="keyword">map</span>[common.Hash][]<span class="keyword">byte</span>),</div><div class="line">		journal:           newJournal(),</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>初始化的时候会利用 <code>OpenTrie</code> 获取 trie，这部分功能由 <code>core/state/database.go</code> 提供，<code>core/state/database.go</code> 封装了与数据库交互的代码，从 database 提供的接口中可以一窥一二。</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> <span class="type">Database</span> interface &#123;</div><div class="line">	<span class="type">OpenTrie</span>(root common.<span class="type">Hash</span>) (<span class="type">Trie</span>, error)</div><div class="line">	<span class="type">OpenStorageTrie</span>(addrHash, root common.<span class="type">Hash</span>) (<span class="type">Trie</span>, error)</div><div class="line">	<span class="type">CopyTrie(Trie)</span> <span class="type">Trie</span></div><div class="line">	<span class="type">ContractCode</span>(addrHash, codeHash common.<span class="type">Hash</span>) ([]byte, error)</div><div class="line">	<span class="type">ContractCodeSize</span>(addrHash, codeHash common.<span class="type">Hash</span>) (int, error)</div><div class="line">	<span class="type">TrieDB</span>() *trie.<span class="type">Database</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>OpenTrie</code> 的会先从缓存中查找 trie，如果没有缓存的话构建个 trie 返回。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">func (<span class="keyword">db</span> *cachingDB) OpenTrie(root common.Hash) (Trie, <span class="keyword">error</span>) &#123;</div><div class="line">	<span class="keyword">db</span>.mu.Lock()</div><div class="line">	defer <span class="keyword">db</span>.mu.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := len(<span class="keyword">db</span>.pastTries) - 1; i &gt;= 0; i-- &#123;</div><div class="line">		<span class="keyword">if</span> <span class="keyword">db</span>.pastTries[i].Hash() == root &#123;</div><div class="line">			<span class="keyword">return</span> cachedTrie&#123;<span class="keyword">db</span>.pastTries[i].<span class="keyword">Copy</span>(), <span class="keyword">db</span>&#125;, nil</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	tr, <span class="keyword">err</span> := trie.NewSecure(root, <span class="keyword">db</span>.<span class="keyword">db</span>, MaxTrieCacheGen)</div><div class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</div><div class="line">		<span class="keyword">return</span> nil, <span class="keyword">err</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> cachedTrie&#123;tr, <span class="keyword">db</span>&#125;, nil</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Database 中还有 <code>OpenStorage</code> 方法，该方法和 OpenTrie 类似；<code>ContractCode</code> 可以用来访问合约代码；<code>ContractCodeSize</code> 用来获取合约的大小；<code>CopyTrie</code> 返回一个指定 trie 的 copy。代码都没有什么特别的，这里不再赘述，</p>
<p>我们接着看 <code>stateDB</code> 提供的功能。我们通过几个例子看看 StateDB 如何与 stateObject，journal，Database 进行交互的。</p>
<h4 id="AddBalance-增加余额"><a href="#AddBalance-增加余额" class="headerlink" title="AddBalance 增加余额"></a>AddBalance 增加余额</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">func (<span class="literal">self</span> *StateDB) AddBalance(addr common.Address, amount *big.Int) &#123;</div><div class="line">	<span class="keyword">state</span>Object := <span class="literal">self</span>.GetOrNewStateObject(addr)</div><div class="line">	if <span class="keyword">state</span>Object != nil &#123;</div><div class="line">		<span class="keyword">state</span>Object.AddBalance(amount)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>core/state/state_object.go</code> 中 <code>AddBalance</code> 方法为：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">func (c *<span class="keyword">state</span>Object) AddBalance(amount *big.Int) &#123;</div><div class="line">	if amount.Sign() == <span class="number">0</span> &#123;</div><div class="line">		if c.empty() &#123;</div><div class="line">			c.touch()</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		return</div><div class="line">	&#125;</div><div class="line">	c.SetBalance(new(big.Int).Add(c.Balance(), amount))</div><div class="line">&#125;</div><div class="line"></div><div class="line">func (<span class="literal">self</span> *<span class="keyword">state</span>Object) SetBalance(amount *big.Int) &#123;</div><div class="line">	<span class="literal">self</span>.db.journal.append(balanceChange&#123;</div><div class="line">		account: &amp;<span class="literal">self</span>.address,</div><div class="line">		prev:    new(big.Int).Set(<span class="literal">self</span>.data.Balance),</div><div class="line">	&#125;)</div><div class="line">	<span class="literal">self</span>.<span class="built_in">set</span>Balance(amount)</div><div class="line">&#125;</div><div class="line"></div><div class="line">func (<span class="literal">self</span> *<span class="keyword">state</span>Object) <span class="built_in">set</span>Balance(amount *big.Int) &#123;</div><div class="line">	<span class="literal">self</span>.data.Balance = amount</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过 journal 记录了一条日志，方便回滚操作：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">func (<span class="keyword">j </span>*<span class="keyword">journal) </span>append(entry <span class="keyword">journalEntry) </span>&#123;</div><div class="line">	<span class="keyword">j.entries </span>= append(<span class="keyword">j.entries, </span>entry)</div><div class="line">	if <span class="keyword">addr </span>:= entry.<span class="keyword">dirtied(); </span><span class="keyword">addr </span>!= nil &#123;</div><div class="line">		<span class="keyword">j.dirties[*addr]++</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="GetBalance-获取余额"><a href="#GetBalance-获取余额" class="headerlink" title="GetBalance 获取余额"></a>GetBalance 获取余额</h4><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">func (<span class="literal">self</span> *StateDB) GetBalance(addr common.Address) *big.Int &#123;</div><div class="line">	<span class="keyword">state</span>Object := <span class="literal">self</span>.getStateObject(addr)</div><div class="line">	if <span class="keyword">state</span>Object != nil &#123;</div><div class="line">		return <span class="keyword">state</span>Object.Balance()</div><div class="line">	&#125;</div><div class="line">	return common.Big0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 <code>core/state/state_object.go</code> 中，Balance 方法为：</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">func (<span class="literal">self</span> *<span class="keyword">state</span>Object) Balance() *big.Int &#123;</div><div class="line">	return <span class="literal">self</span>.data.Balance</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>data 是 账户类型，在 stateObject 中已有缓存。</p>
<p>通过写入余额，获取余额的两个例子，我们知道了 StateDB 提供的功能，以及 journal，state_object 模块的职责，可以看到目前为止这些功能还是在内存里操作的，而世界状态最终还是会写到 LevelDB 里。</p>
<h4 id="Commit-提交当前状态"><a href="#Commit-提交当前状态" class="headerlink" title="Commit 提交当前状态"></a>Commit 提交当前状态</h4><p>通过 StateDB 的 Commit 方法可以写入当前的世界状态到数据库中。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">func (s *StateDB) Commit(deleteEmptyObjects bool) (root common.Hash, err error) &#123;</div><div class="line">	defer s.clearJournalAndRefund()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> addr := range s.journal.dirties &#123;</div><div class="line">		s.<span class="keyword">state</span>ObjectsDirty[addr] = struct&#123;&#125;&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> addr, <span class="keyword">state</span>Object := range s.<span class="keyword">state</span>Objects &#123;</div><div class="line">		_, isDirty := s.<span class="keyword">state</span>ObjectsDirty[addr]</div><div class="line">		switch &#123;</div><div class="line">		case <span class="keyword">state</span>Object.suicided || (isDirty &amp;&amp; deleteEmptyObjects &amp;&amp; <span class="keyword">state</span>Object.empty()):</div><div class="line">			s.deleteStateObject(<span class="keyword">state</span>Object)</div><div class="line">		case isDirty:</div><div class="line">			if <span class="keyword">state</span>Object.code != nil &amp;&amp; <span class="keyword">state</span>Object.dirtyCode &#123;</div><div class="line">				s.db.TrieDB().InsertBlob(common.BytesToHash(<span class="keyword">state</span>Object.CodeHash()), <span class="keyword">state</span>Object.code)</div><div class="line">				<span class="keyword">state</span>Object.dirtyCode = false</div><div class="line">			&#125;</div><div class="line">			if err := <span class="keyword">state</span>Object.CommitTrie(s.db); err != nil &#123;</div><div class="line">				return common.Hash&#123;&#125;, err</div><div class="line">			&#125;</div><div class="line">			s.updateStateObject(<span class="keyword">state</span>Object)</div><div class="line">		&#125;</div><div class="line">		delete(s.<span class="keyword">state</span>ObjectsDirty, addr)</div><div class="line">	&#125;</div><div class="line">	root, err = s.trie.Commit(func(leaf []byte, parent common.Hash) error &#123;</div><div class="line">		var account Account</div><div class="line">		if err := rlp.DecodeBytes(leaf, &amp;account); err != nil &#123;</div><div class="line">			return nil</div><div class="line">		&#125;</div><div class="line">		if account.Root != emptyState &#123;</div><div class="line">			s.db.TrieDB().Reference(account.Root, parent)</div><div class="line">		&#125;</div><div class="line">		code := common.BytesToHash(account.CodeHash)</div><div class="line">		if code != emptyCode &#123;</div><div class="line">			s.db.TrieDB().Reference(code, parent)</div><div class="line">		&#125;</div><div class="line">		return nil</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">log</span>.Debug(<span class="string">"Trie cache stats after commit"</span>, <span class="string">"misses"</span>, trie.CacheMisses(), <span class="string">"unloads"</span>, trie.CacheUnloads())</div><div class="line">	return root, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终通过 <code>core/state/database.go</code> 中的 Commit 实现。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m cachedTrie)</span> <span class="title">Commit</span><span class="params">(onleaf trie.LeafCallback)</span> <span class="params">(common.Hash, error)</span></span> &#123;</div><div class="line">	root, err := m.SecureTrie.Commit(onleaf)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		m.db.pushTrie(m.SecureTrie)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> root, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="IntermediateRoot-获取当前世界状态哈希"><a href="#IntermediateRoot-获取当前世界状态哈希" class="headerlink" title="IntermediateRoot 获取当前世界状态哈希"></a><code>IntermediateRoot</code> 获取当前世界状态哈希</h4><p>还记得我们在 <a href="https://knarfeh.com/2018/03/10/go-ethereum%20%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0%EF%BC%88trie%20%E6%A8%A1%E5%9D%97-MPT%20%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%89/" target="_blank" rel="external">go-ethereum 源码笔记（trie 模块-MPT 的实现）</a>  提到 <code>stateTrie</code> 比较特别，交易执行时，<code>stateTrie</code> 一直在变化，前文中提到，交易执行的入口函数 <code>StateProcessor.Process()</code> 会调用 <code>Engine</code> 的 <code>Finalize()</code> 方法，而 <code>Finalize</code> 方法最终会调用 <code>IntermediateRoot</code>  方法获取世界状态的当前 root 值并返回给 header.Root 进行赋值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *StateDB)</span> <span class="title">IntermediateRoot</span><span class="params">(deleteEmptyObjects <span class="keyword">bool</span>)</span> <span class="title">common</span>.<span class="title">Hash</span></span> &#123;</div><div class="line">	s.Finalise(deleteEmptyObjects)</div><div class="line">	<span class="keyword">return</span> s.trie.Hash()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前面提到这个方法会在交易执行的过程中被调用，返回的哈希值会被存到交易收据树里。</p>
<h4 id="snapshot-快照功能"><a href="#snapshot-快照功能" class="headerlink" title="snapshot 快照功能"></a>snapshot 快照功能</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(<span class="keyword">self</span> *StateDB)</span></span> <span class="type">Snapshot</span>() int &#123;</div><div class="line">	id := <span class="keyword">self</span>.nextRevisionId</div><div class="line">	<span class="keyword">self</span>.nextRevisionId++</div><div class="line">	<span class="keyword">self</span>.validRevisions = append(<span class="keyword">self</span>.validRevisions, revision&#123;id, <span class="keyword">self</span>.journal.length()&#125;)</div><div class="line">	<span class="keyword">return</span> id</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(<span class="keyword">self</span> *StateDB)</span></span> <span class="type">RevertToSnapshot</span>(revid int) &#123;</div><div class="line">	idx := <span class="built_in">sort</span>.<span class="type">Search</span>(len(<span class="keyword">self</span>.validRevisions), <span class="function"><span class="keyword">func</span><span class="params">(i int)</span></span> bool &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">self</span>.validRevisions[i].id &gt;= revid</div><div class="line">	&#125;)</div><div class="line">	<span class="keyword">if</span> idx == len(<span class="keyword">self</span>.validRevisions) || <span class="keyword">self</span>.validRevisions[idx].id != revid &#123;</div><div class="line">		panic(fmt.<span class="type">Errorf</span>(<span class="string">"revision id %v cannot be reverted"</span>, revid))</div><div class="line">	&#125;</div><div class="line">	snapshot := <span class="keyword">self</span>.validRevisions[idx].journalIndex</div><div class="line"></div><div class="line">	<span class="keyword">self</span>.journal.revert(<span class="keyword">self</span>, snapshot)</div><div class="line">	<span class="keyword">self</span>.validRevisions = <span class="keyword">self</span>.validRevisions[:idx]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Snapshot</code> 方法用来创建当前世界状态的快照，<code>RevertToSnapshot</code> 可以根据快照 id 进行回滚，这个功能通过 <code>core/state/journal.go</code> 的 <code>revert</code> 实现。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">func (<span class="keyword">j </span>*<span class="keyword">journal) </span>revert(statedb *StateDB, snapshot int) &#123;</div><div class="line">	for i := len(<span class="keyword">j.entries) </span>- <span class="number">1</span><span class="comment">; i &gt;= snapshot; i-- &#123;</span></div><div class="line">		<span class="keyword">j.entries[i].revert(statedb)</span></div><div class="line"></div><div class="line">		if <span class="keyword">addr </span>:= <span class="keyword">j.entries[i].dirtied(); </span><span class="keyword">addr </span>!= nil &#123;</div><div class="line">			if <span class="keyword">j.dirties[*addr]--; </span><span class="keyword">j.dirties[*addr] </span>== <span class="number">0</span> &#123;</div><div class="line">				delete(<span class="keyword">j.dirties, </span>*<span class="keyword">addr)</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">j.entries </span>= <span class="keyword">j.entries[:snapshot]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://github.com/ZtesoftCS/go-ethereum-code-analysis/blob/master/core-state%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md" target="_blank" rel="external">core-state源码分析</a></li>
<li><a href="http://www.wjblog.top/articles/d8361364/" target="_blank" rel="external">How does Ethereum work, anyway?</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/cryptocurrency/" rel="tag">#cryptocurrency</a>
          
            <a href="/tags/Golang/" rel="tag">#Golang</a>
          
            <a href="/tags/geth/" rel="tag">#geth</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/10/go-ethereum 源码笔记（ethdb 模块）/" rel="next" title="go-ethereum 源码笔记（ethdb 模块）">
                <i class="fa fa-chevron-left"></i> go-ethereum 源码笔记（ethdb 模块）
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/20/Telegram Bot 的长轮询 VS Webhook/" rel="prev" title="Telegram Bot 的长轮询 VS Webhook">
                Telegram Bot 的长轮询 VS Webhook <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars1.githubusercontent.com/u/6964284?v=3&s=460"
               alt="Frank" />
          <p class="site-author-name" itemprop="name">Frank</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">182</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">131</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/knarfeh" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/knarfeh" target="_blank">
                  
                    <i class="fa fa-twitter"></i> Twitter
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/2753500945" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#插入区块更新状态"><span class="nav-number">1.</span> <span class="nav-text">插入区块更新状态</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Process"><span class="nav-number">1.1.</span> <span class="nav-text">Process</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transition"><span class="nav-number">1.2.</span> <span class="nav-text">Transition</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#state-模块"><span class="nav-number">2.</span> <span class="nav-text">state 模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#存储以太坊合约和账户-StateDB"><span class="nav-number">2.1.</span> <span class="nav-text">存储以太坊合约和账户 StateDB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#数据结构"><span class="nav-number">2.1.1.</span> <span class="nav-text">数据结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化"><span class="nav-number">2.1.2.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AddBalance-增加余额"><span class="nav-number">2.1.3.</span> <span class="nav-text">AddBalance 增加余额</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GetBalance-获取余额"><span class="nav-number">2.1.4.</span> <span class="nav-text">GetBalance 获取余额</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Commit-提交当前状态"><span class="nav-number">2.1.5.</span> <span class="nav-text">Commit 提交当前状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IntermediateRoot-获取当前世界状态哈希"><span class="nav-number">2.1.6.</span> <span class="nav-text">IntermediateRoot 获取当前世界状态哈希</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#snapshot-快照功能"><span class="nav-number">2.1.7.</span> <span class="nav-text">snapshot 快照功能</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">3.</span> <span class="nav-text">References</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frank</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.scheme !== 'Pisces' && (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always')) {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'knarfeh';
      var disqus_identifier = '2018/03/10/go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）/';
      var disqus_title = 'go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）';
      var disqus_url = 'http://knarfeh.github.io/2018/03/10/go-ethereum 源码笔记（core 模块-世界状态，交易收据管理）/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
    <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
  


  

  <script type="text/javascript" src="/js/src/custom.js"></script>
</body>
</html>
